<?php
// Check if the constant 'ABSPATH' is not defined (WordPress base path constant) 
// OR the function 'vc_map' does not exist (commonly used by Visual Composer).
if (!defined('ABSPATH') || !function_exists('vc_map')) {
    return;
}

class BUDI_VIDEO_GRID extends BUDI_SHORTCODE_BASE
{

    /**
     * __construct
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * get_name
     */
    protected function get_name()
    {
        return 'budi_video_grid';
    }

    /**
     * get_title
     */
    protected function get_title()
    {
        return __('Budi Video Grid', _BUDI_TEXT_DOMAIN);
    }

    /**
     * render_asset_lists
     */
    protected function render_asset_lists()
    {
        // Enqueue CSS & JS
        wp_enqueue_style($this->generate_asset_id(), this_dir_url(__FILE__) . "{$this->generate_asset_id()}.css", array(), _BUDI_VERSION);
    }

    /**
     * register_controls
     */
    public function register_controls()
    {
        $args = array(
            'name' => $this->widget_title,
            'base' => $this->widget_name,
            'category' => _BUDI_CATEGORY_WIDGET_NAME,
            'content_element' => true,
            "show_settings_on_create" => false,
            "is_container" => false,
            'params' => array(
                array(
                    'type' => 'param_group',
                    'heading' => __('Video Items', _BUDI_TEXT_DOMAIN),
                    'param_name' => 'video_items',
                    'params' => array(
                        array(
                            'type' => 'textarea',
                            'heading' => __('Title', _BUDI_TEXT_DOMAIN),
                            'param_name' => 'title',
                            'admin_label' => true,
                        ),
                        array(
                            'type' => 'textfield',
                            'heading' => __('Sub Title', _BUDI_TEXT_DOMAIN),
                            'param_name' => 'sub_title',
                            'admin_label' => true,
                        ),
                        array(
                            'type' => 'textfield',
                            'heading' => __('Video URL', _BUDI_TEXT_DOMAIN),
                            'param_name' => 'video_url',
                            'admin_label' => false,
                        ),
                        array(
                            "type" => "attach_image",
                            "class" => "",
                            "heading" => __('Video Poster', _BUDI_TEXT_DOMAIN),
                            "param_name" => "video_poster",
                            'admin_label' => false,
                        ),
                    )
                ),
                array(
                    'type' => 'checkbox',
                    'heading' => __('Player Controls', _BUDI_TEXT_DOMAIN),
                    'param_name' => 'control_self_hosted',
                    'value' => array(
                        __('Yes', _BUDI_TEXT_DOMAIN) => 'yes'
                    ),
                    'std' => 'yes',
                    'admin_label' => false,
                    'group' => 'Video Settings',
                ),
                array(
                    'type' => 'checkbox',
                    'heading' => __('Mute', _BUDI_TEXT_DOMAIN),
                    'param_name' => 'mute_self_hosted',
                    'value' => array(
                        __('Yes', _BUDI_TEXT_DOMAIN) => 'yes'
                    ),
                    'admin_label' => false,
                    'group' => 'Video Settings',
                ),
                array(
                    'type' => 'checkbox',
                    'heading' => __('Loop', _BUDI_TEXT_DOMAIN),
                    'param_name' => 'loop_self_hosted',
                    'value' => array(
                        __('Yes', _BUDI_TEXT_DOMAIN) => 'yes'
                    ),
                    'admin_label' => false,
                    'group' => 'Video Settings',
                ),
                array(
                    'type' => 'attach_image',
                    'heading' => __('Icon Play Button', _BUDI_TEXT_DOMAIN),
                    'param_name' => 'icon_play_button',
                    'description' => __('If you&apos;re not using a custom play button icon, leave this field blank.', _BUDI_TEXT_DOMAIN),
                    'group' => 'Video Settings',
                ),

                ...$this->get_design_options_controls(),
            ),
        );

        vc_map($args);
    }

    /**
     * render_view
     */
    public function render_view($atts, $content = null)
    {
        ob_start();

        $atts = shortcode_atts([
            'video_items'         => '',
            'control_self_hosted' => 'yes',
            'mute_self_hosted'    => '',
            'loop_self_hosted'    => '',
            'icon_play_button'    => '',
            'widget_class'        => '',
            'css'                 => '',
        ], $atts);

        $control_self_hosted = $atts['control_self_hosted'];
        $mute_self_hosted    = $atts['mute_self_hosted'];
        $loop_self_hosted    = $atts['loop_self_hosted'];
        $icon_play_button    = $atts['icon_play_button'];
        $widget_class        = sc_merge_css($atts['css'], $atts['widget_class']);
        $widget_id           = $this->widget_id . uniqid();

        $video_items = vc_param_group_parse_atts($atts['video_items']);

        if ($video_items): ?>

            <div class="budi-video-grid__wrapper <?php echo esc_attr($widget_class); ?>" id="<?php echo esc_attr($widget_id); ?>">

                <?php foreach ($video_items as $item):
                    $video_url        = $item['video_url'];
                    $video_poster     = $item['video_poster'] ?? '';
                    $video_title      = $item['title'];
                    $video_sub_title  = $item['sub_title'];

                    if ($video_poster) {
                        if (wp_http_validate_url($video_poster)) {
                            $video_poster_url = $video_poster;
                        } else {
                            $video_poster_url = wp_get_attachment_image_url($video_poster, 'full', false);
                        }
                    }

                    if (empty($video_url)) continue; ?>

                    <div class="budi-video-grid__item budi-video-wrapper">
                        <div class="budi-video-grid__item-inner position-relative overflow-hidden">

                            <div class="budi-video-overlay"></div>
                            <?php
                            $atts['video_url']    = $video_url;
                            $atts['video_poster'] = $video_poster;


                            echo sprintf(
                                '<video preload="none" %s %s %s %s playsinline="" class="budi-video" data-src="%s"></video>',
                                $control_self_hosted === 'yes' ? 'controls' : '',
                                $loop_self_hosted === 'yes' ? 'loop' : '',
                                $mute_self_hosted === 'yes' ? 'muted' : '',
                                !empty($video_poster_url) ? sprintf('poster="%s"', esc_url($video_poster_url)) : '',
                                esc_url($video_url),
                            );

                            if ($icon_play_button) {
                                echo wp_get_attachment_image($icon_play_button, 'full', false, array(
                                    'class' => 'budi-video-play-button position-absolute'
                                ));
                            }
                            ?>

                            <div class="video-grid-item__content position-absolute text-center">
                                <?php if (!empty($video_sub_title)): ?>
                                    <p class="video-grid-item__subtitle mx-0 text-white"><?php echo $video_sub_title; ?></p>
                                <?php endif; ?>
                                <?php if (!empty($video_title)): ?>
                                    <h3 class="video-grid-item__title mb-0 text-white position-relative d-inline-block"><?php echo $video_title; ?></h3>
                                <?php endif; ?>
                            </div>
                        </div>

                    </div>

                <?php endforeach; ?>

            </div>

            <script>
                (function($) {
                    $(document).ready(function() {
                        const $widget_id = $('#<?php echo $widget_id; ?>');

                        // Video play button on click
                        $($widget_id).on('click', '.budi-video-play-button', function(e) {
                            const $this = $(this);
                            const $video = $this.siblings('video');

                            $video.attr("src", $video.data("src"));
                            $this.fadeOut(300);
                            $video[0].play();
                            $video.prop('controls', true);

                            const $video_grid_item = $(this).closest('.budi-video-grid__item');
                            $video_grid_item.find('.budi-video-overlay, .video-grid-item__content').fadeOut(300);

                            // Video On Play
                            $video.on('play', function() {
                                if ($this.length > 0) {
                                    $this.fadeOut(300);
                                    $video.prop('controls', true);
                                }
                            });

                            // Video On Pause
                            $video.on('pause', function() {
                                $this.fadeIn(300);
                                $video.prop('controls', <?php echo $control_self_hosted === "yes" ? 'true' : 'false'; ?>);
                                $video.attr("src", '');

                                $video_grid_item.find('.budi-video-overlay, .video-grid-item__content').fadeIn(300);
                            });
                        });
                    });
                })(jQuery);
            </script>

<?php endif;

        return ob_get_clean();
    }
}

new BUDI_VIDEO_GRID();
